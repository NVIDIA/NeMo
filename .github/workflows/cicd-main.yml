# Copyright (c) 2020-2021, NVIDIA CORPORATION.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
name: "CICD NeMo"

on:
  push:
    branches: [ "main", "pagaray/nemo_cicd" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "main", "pagaray/nemo_cicd" ]

jobs:
  gpu-test:
    runs-on: self-hosted-azure
    steps:
    - name: Run nvidia-smi test
      run: |
        whoami
        nvidia-smi

  cicd-test-container-setup:
    runs-on: self-hosted-azure
    container:
      image: nvcr.io/nvidia/pytorch:23.10-py3
      options: 
        # --user 0:128
        --device=/dev/nvidia0
        --gpus all
        --shm-size=8g 
        --env TRANSFORMERS_OFFLINE=0 
        --env HYDRA_FULL_ERROR=1
    steps:
    - name: PyTorch version
      run: |
        python -c "import torch; print(torch.__version__)"
        python -c "import torchvision; print(torchvision.__version__)"

    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install test requirements
      run: |
        apt-get update && apt-get install -y bc && pip install -r requirements/requirements_test.txt && pip install -r requirements/requirements_lightning.txt
      
    - name: Code formatting checks
      run: |
        python setup.py style
      
    - name: Copyright Headers check
      run: |
        python tests/check_copyright_header.py --dir .

    - name: NeMo Installation
      run: |
        ./reinstall.sh release

    # Transformer Engine 1.2.0
    - name: Transformer Engine installation
      run: |
         git clone https://github.com/NVIDIA/TransformerEngine.git && \
             cd TransformerEngine && \
             git fetch origin 4f9662fbe621671f5f905e772fc1138953af77f6 && \
             git checkout FETCH_HEAD && \
             git submodule init && git submodule update && \
             NVTE_FRAMEWORK=pytorch NVTE_WITH_USERBUFFERS=1 MPI_HOME=/usr/local/mpi pip install .

    # Apex bugfix for PyTorch 23.11 container: https://github.com/NVIDIA/apex/pull/1760
    - name: Apex installation
      run: |
         git clone https://github.com/NVIDIA/apex.git && \
             cd apex && \
             git checkout c07a4cf67102b9cd3f97d1ba36690f985bae4227 && \
             cp -R apex /usr/local/lib/python3.10/dist-packages
      

    # pip package should be working with main, if not we can update the commit here
    # until the pip package is updated
    - name: Megatron Core installation
      run: |
         git clone https://github.com/NVIDIA/Megatron-LM.git && \
             cd Megatron-LM && \
             git checkout bed60a881f4b238b1c14b6c6a64997cc636e77b6 && \
             pip install .


    - name: PyTorch Lightning version
      run: |
        python -c "import pytorch_lightning; print(pytorch_lightning.__version__)"

    - name: PyTorch Lightning DDP Checks
      run: |
        CUDA_VISIBLE_DEVICES="0,1" python "tests/core_ptl/check_for_ranks.py"


    - name: Basic Import Checks
      run: |
        python -c "import nemo.collections.asr as nemo_asr"
        python -c "import nemo.collections.nlp as nemo_nlp"
        python -c "import nemo.collections.tts as nemo_tts"
      

  cicd-tests:
    needs: [cicd-test-container-setup]
    runs-on: self-hosted-azure
    container:
      image: nvcr.io/nvidia/pytorch:23.10-py3
      options: 
        # --user 0:128
        --device=/dev/nvidia0
        --gpus all
        --shm-size=8g 
        --env TRANSFORMERS_OFFLINE=0 
        --env HYDRA_FULL_ERROR=1
    steps:
    - name: "L0: Unit Tests GPU"
      run: |
        NEMO_NUMBA_MINVER=0.53 pytest -m "not pleasefixme" --with_downloads

  cicd-tests:
    needs: [cicd-test-container-setup]
    runs-on: self-hosted-azure
    container:
      image: nvcr.io/nvidia/pytorch:23.10-py3
      options: 
        # --user 0:128
        --device=/dev/nvidia0
        --gpus all
        --shm-size=8g 
        --env TRANSFORMERS_OFFLINE=0 
        --env HYDRA_FULL_ERROR=1
    steps:
    - name: "L0: Unit Tests CPU"
      run: |
        CUDA_VISIBLE_DEVICES="" NEMO_NUMBA_MINVER=0.53 pytest -m "not pleasefixme" --cpu --with_downloads --relax_numba_compat

##     - name: L2: Multimodal Imagen Train


 